- project:
    name: 'nfs_ganesha'
    flavours:
      - iozone:
          recheck_val: 'iozone$'
      - iozone_vfs:
          recheck_val: 'iozone_vfs$'
      - iozone_vfs_minmdcache:
          recheck_val: 'iozone_vfs_minmdcache$'

    jobs:
      - '{name}_{flavours}'

- job-template:
    name: '{name}_{flavours}'
    node: cico-workspace
    project-type: freestyle
    concurrent: true 
    allow-manual-triggers: true 
    disabled: true
    logrotate:
      daysToKeep: 14

    scm:
      - git:
          branches:
            - 'refs/heads/main'
          browser: auto
          skip-tag: true
          shallow-clone: true
          url: https://github.com/rakshithakamath94/nfs-ci-jobs.git
          basedir: "$WORKSPACE/nfs-ci-jobs"

    parameters:
    - string:
        default: https://raw.githubusercontent.com/nfs-ganesha/ci-tests/centos-ci/common-scripts/basic-vfs-duffy.py
        description: 'Python script that reserves a machine from Duffy and starts the TEST_SCRIPT'
        name: DUFFY_SCRIPT
    - string:
        default: https://raw.githubusercontent.com/nfs-ganesha/ci-tests/centos-ci/common-scripts/basic-vfs-minmd.sh
        description: Test script to execute on the reserved machine acting as a server.
        name: SERVER_TEST_SCRIPT
    - string:
        default: https://raw.githubusercontent.com/nfs-ganesha/ci-tests/centos-ci/iozone/client.sh
        description: Test script to execute on the reserved machine acting as a client.
        name: CLIENT_TEST_SCRIPT
    - string:
        default: ''
        description: URL to the .repo file to use for installing NFS-Ganesha
        name: YUM_REPO
    - string:
        default: 'review.gerrithub.io'
        description: 'Hostname of the Gerrit server.'
        name: GERRIT_HOST
    - string:
        default: ffilz/nfs-ganesha
        description: Project name from Gerrit (like "ffilz/nfs-ganesha").
        name: GERRIT_PROJECT
    - string:
        default: refs/heads/next
        description: Git reference to fetch from the Gerrit project.
        name: GERRIT_REFSPEC
    - string:
        default: ganeshaExport
        description: Name of the NFS-export to create.
        name: EXPORT
    - choice:
        choices:
        - "7"
        - "6"
        description: 'CentOS version to run the tests on (server + client)'
        name: CENTOS_VERSION
    - choice:
        choices:
        - x86_64
        - i386
        description: 'CentOS architecture to run the tests on (server + client)'
        name: CENTOS_ARCH

    builders:
    - shell: !include-raw-escape: ../scripts/iozone.sh 

    triggers:
      - gerrit:
          server-name: nfs-ganesha-gerrithub 
          silent: true
          trigger-on:
            - patchset-created-event:
                exclude-drafts: true
                exclude-no-code-change: true
            - comment-added-contains-event: 
                comment-contains-value: 'recheck {recheck_val}' 
          projects:
            - project-compare-type: PLAIN
              project-pattern: 'ffilz/nfs-ganesha'
              branches:
                - branch-pattern: '**' 
                  branch-compare-type: ANT

    wrappers:
      - workspace-cleanup:
          include: ''
